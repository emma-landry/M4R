---
title: "State_Regression"
author: "Emma Landry"
date: "4/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(epidemia)
library(dplyr)
library(here)
library(readr)
library(readxl)
library(rstan)
library(ggplot2)
library(GGally)
library(reshape2) #for melt
library(urbnmapr)
library(tidyverse)
library(rstanarm)
```

```{r}
short_state <- c("AL","AZ", "AR", "CA","CO","CT","DE","FL","GA","ID","IL","IN","IA","KS","KY",
                 "LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND",
                 "OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY") 
```

Columns Needed:
-Over 18 total pop
-Over 18 population hesitating
-don't like vaccines
-dont trust covid 19 vaccines
-don't trust the government
-other people need it more right now (could be negatively correlated with trump voting)

```{r}
zeros <- rep(0, 48)
vax <- data.frame("STATE" = short_state,
                  "TOT_POP" = zeros, 
                  "TOT_HESIT" = zeros,
                  "NO_LIKE" = zeros,
                  "NO_VAX_TRUST"= zeros,
                  "NO_GOV_TRUST"= zeros,
                  "OTHERS_NEED"= zeros)
```


```{r}
for (i in seq(1:48)){
  df1 <- read_excel(here::here("data", "vaccination_hesitancy", "health5_week22.xlsx"), sheet = short_state[i])
  df2 <-read_excel(here::here("data", "vaccination_hesitancy", "health6_week22.xlsx"), sheet = short_state[i])
  vax$TOT_POP[i] <- df1[8,2]
  vax$TOT_HESIT[i]<- df2[7,2]
  vax$NO_LIKE[i]<- df2[7,6]
  vax$NO_VAX_TRUST[i] <- df2[7,11]
  vax$NO_GOV_TRUST[i] <- df2[7,12]
  vax$OTHERS_NEED[i] <- df2[7,9]
}
```

```{r}
vax$TOT_POP <- as.numeric(vax$TOT_POP)
vax$TOT_HESIT <- as.numeric(vax$TOT_HESIT)
vax$NO_LIKE <- as.numeric(vax$NO_LIKE)
vax$NO_VAX_TRUST<- as.numeric(vax$NO_VAX_TRUST)
vax$NO_GOV_TRUST <- as.numeric(vax$NO_GOV_TRUST)
vax$OTHERS_NEED <- as.numeric(vax$OTHERS_NEED)
```

```{r}
vax_prop <- data.frame("STATE"= vax$STATE,
                       "TOT_POP"= vax$TOT_POP,
                       "HESIT" = vax$TOT_HESIT/ vax$TOT_POP,
                       "NO_LIKE" = vax$NO_LIKE/vax$TOT_HESIT,
                       "NO_VAX_TRUST"= vax$NO_VAX_TRUST/vax$TOT_HESIT,
                       "NO_GOV_TRUST"= vax$NO_GOV_TRUST/vax$TOT_HESIT,
                       "OTHERS_NEED"= vax$OTHERS_NEED/vax$TOT_HESIT
                       )
```

```{r}
elec <- read.csv(here::here("data", "election", "1976-2020-president.csv"))
elec <- subset(elec, ((elec$year==2020 | elec$year==2016)& elec$party_simplified=="REPUBLICAN"))
elec <- subset(elec, (elec$state!= "DISTRICT OF COLUMBIA" & elec$state != "ALASKA" & elec$state!= "HAWAII" & elec$writein == FALSE) )
```

```{r}
prop_2020 <- subset(elec, elec$year==2020)$candidatevotes /subset(elec, elec$year==2020)$totalvotes
prop_2016 <- subset(elec, elec$year==2016)$candidatevotes /subset(elec, elec$year==2016)$totalvotes
change <- (prop_2020-prop_2016)
```


```{r}
trump_data <- data.frame("STATE"= subset(elec, elec$year==2020)$state_po,
                         "VOTES_2020" = prop_2020,
                         "CHANGE_2020" = change)
```

```{r}
path <- "/Volumes/evl17/home/Msc/Outputs/rt_medians/state1/"
path <- paste0(path, "alabama_3395374[1].pbs_medians.rds")
```

```{r}
long_state <- c("alabama", "alaska", "arizona", "arkansas", "california", "colorado", "connecticut",
                "delaware", "florida", "georgia", "idaho", "illinois","indiana","iowa", "kansas",
                "kentucky", "louisiana", "maine", "maryland", "massachusetts", "michigan",
                "minnesota", "mississippi", "missouri","montana", "nebraska", "nevada","new_hampshire",
                "new_jersey", "new_mexico", "new_york", "north_carolina", "north_dakota", "ohio",
                "oklahoma", "oregon", "pennsylvania", "rhode_island", "south_carolina",
                "south_dakota", "tennessee", "texas", "utah", "vermont", "virginia", "washington",
                "west_virginia","wisconsin", "wyoming")
```

```{r}
medians <- read.csv("/Volumes/evl17/home/Msc/Outputs/rt_medians/state1/alabama_3395374[1].pbs_medians.rds")

```

```{r}
file_list <- list.files(path= "/Volumes/evl17/home/Msc/Outputs/rt_medians/state1")
file_list
```


```{r}
meds <- c()
for (i in seq(1:49)){
  path <- paste0("/Volumes/evl17/home/Msc/Outputs/rt_medians/state1/", file_list[i])
  medians <- read.csv(path)
  meds <- c(meds,nrow(medians) )
}
```


```{r}
min(meds)
max(meds)
```
Corresponds to South Carolina and California

```{r}
epifit_sc <- readRDS("/Volumes/evl17/home/Msc/Outputs/epidemia_fits/state1/rhode_island_3395374[38].pbs.rds")
```

```{r}
rt <- posterior_rt(epifit_sc$fit)
times<- rt$time
```

```{r}
path <- paste0("/Volumes/evl17/home/Msc/Outputs/rt_medians/state1/", file_list[5])
medians <- read.csv(path)
meds <- c(meds,nrow(medians) )
```

```{r}
medians_end <- tail(medians, 379)
medians_end$Date <- times
medians_end <- medians_end[,-1]
colnames(medians_end)<- c("Median", "Date")
```


Times I am interested in:
-Summer: 01/07-31/08 index 106:167
-Two months before election: 04/09- 04/11 index 171: 232
-From 15/11 to 15/01 index 243: 304

```{r}
average_rt <- data.frame("STATE"= short_state,
                         "VALS1"= zeros,
                         "VALS2"= zeros,
                         "VALS3"= zeros,
                         "election_day"= zeros)
```

```{r}
for (i in seq(1:49)){
  if (i==2) next
  
  path <- paste0("/Volumes/evl17/home/Msc/Outputs/rt_medians/state1/", file_list[i])
  medians <- read.csv(path)
  medians_end <- tail(medians, 379)
  medians_end$Date <- times
  medians_end <- medians_end[,-1]
  colnames(medians_end)<- c("Median", "Date")
  
  val1 <- mean(medians_end$Median[106:167])
  val2 <- mean(medians_end$Median[171:232])
  val3 <- mean(medians_end$Median[243:304])
  val4<- medians_end$Median[232]
  
  if (i==1){
  average_rt$VALS1[i] <- val1
  average_rt$VALS2[i] <- val2
  average_rt$VALS3[i] <- val3
  average_rt$election_day[i] <- val4
  }
  else{
    average_rt$VALS1[i-1] <- val1
    average_rt$VALS2[i-1] <- val2
    average_rt$VALS3[i-1] <- val3
     average_rt$election_day[i-1] <- val4
  }
}
```


Combined features
```{r}
features <- merge(vax_prop, trump_data, by= "STATE")
features <- features[,-2]
```


```{r}
#pdf("ggpairstate.pdf", width = 15, height= 15, pointsize = 12)
g<- ggpairs(features[,2:8]) +theme_bw()
g
ggsave("ggpairstate.pdf", width = 16, height = 16)
#print(g)
#dev.off()
```


```{r}
cor_matrix <- cor(features[,2:8])
melted_cor <- melt(cor_matrix)

#pdf("correlation.pdf", width = 10, height= 10, pointsize = 40)
ggplot(data = melted_cor, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()+
  scale_fill_gradient2(high = "#F8766D", low = "#00BFC4", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab",
                       name="Pearson\nCorrelation") +
  xlab("")+
  ylab("")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 270, vjust = 0.5, hjust=0))
ggsave("correlation.pdf", width = 10, height = 9)
#dev.off()

```

```{r}
states_urbn <- states
cnames_urbn<- colnames(states_urbn)
cnames_urbn[8] <- "STATE"
colnames(states_urbn) <- cnames_urbn
```


```{r}
ccdf_labels <- get_urbn_labels(map = "ccdf")
ccdf_labels <- ccdf_labels[-c(2,3, 10,13,14,23,43,51),]

map_plots <- left_join(features, states_urbn, by = "STATE")
map_plots <- left_join(map_plots, average_rt, by = "STATE")

ggplot() +
  geom_polygon(data= map_plots,mapping = aes(long, lat, group = group, fill = VOTES_2020),color = "#ffffff", size = 0.25) +
  scale_fill_gradient2(labels = scales::percent, guide = guide_colourbar(direction = "horizontal",title.position = "top"),low = "dodgerblue4", mid = "white", high = "red", midpoint = 0.5) +
  geom_text(data = ccdf_labels, aes(long, lat, label = state_abbv), size = 4) +  
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void()+
  theme(legend.title = element_text(hjust = 0.5, size = 14),
        legend.key.width = unit(.4, "in"),
        legend.position="top") +
  labs(fill = "Percentage Votes Trump")
ggsave("state_votes_map.pdf", height = 5, scale = 1)
```


```{r}
ggplot() +
  geom_polygon(data= map_plots,mapping = aes(long, lat, group = group, fill = HESIT),color = "#ffffff", size = 0.25) +
   scale_fill_gradient2(labels = scales::percent, guide = guide_colourbar(direction = "horizontal",title.position = "top"),low = "dodgerblue4", mid = "white", high = "red", midpoint = 0.45) +
  geom_text(data = ccdf_labels, aes(long, lat, label = state_abbv), size = 4) +  
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  theme_void()+
  theme(legend.title = element_text(hjust = 0.5, size = 14),
        legend.key.width = unit(.4, "in"),
        legend.position="top") +
  labs(fill = "Vaccine Hesitancy")
ggsave("state_hesitancy_map.pdf")
```
```{r}
ggplot() +
  geom_polygon(data= map_plots,mapping = aes(long, lat, group = group, fill = election_day),color = "#ffffff", size = 0.25) +
  scale_fill_gradientn(guide = guide_colourbar(direction = "horizontal",title.position = "top", nbin = 10000),colours = c( "lightskyblue","dodgerblue4","lightpink", "firebrick3"), 
                         values = scales::rescale(c(0.93, 1 - 0.00000000001, 1, 2))) +
  geom_text(data = ccdf_labels, aes(long, lat, label = state_abbv), size = 4) +  
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(fill = expression (R[t]))+
  theme_void()+
  theme(legend.title = element_text(hjust = 0.5, size = 14),
        legend.key.width = unit(.4, "in"),
        legend.position="top") 
ggsave("state_rt_map.pdf", height =5, scale =1)
```


Start with fitting the nov-jan rt
```{r}
matrix1 <- merge(average_rt, features, by = "STATE")
matrix1 <- matrix1[,-1]
```

Just votes:
```{r}
lm1 <- lm (VALS3 ~ VOTES_2020, data = matrix1)
summary(lm1)

ggplot(matrix1, aes(x = VOTES_2020, y = VALS3)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")
```
```{r}
lm1 <- stan_lm (election_day ~ VOTES_2020, data = matrix1, prior = R2(0.5, what = "mean"))
lm2 <- stan_lm (election_day ~ VOTES_2020+ CHANGE_2020, data = matrix1, prior = R2(0.5, what = "mean"))
lm3 <- stan_lm(election_day ~ HESIT, data= matrix1, prior = R2(0.5, what = "mean"))
lm4 <- stan_lm(election_day ~ NO_GOV_TRUST+ HESIT, data = matrix1, prior = R2(0.5, what = "mean"))
lm5 <- stan_lm(election_day ~  HESIT + NO_LIKE+ NO_VAX_TRUST+ NO_GOV_TRUST+ OTHERS_NEED+ VOTES_2020+ CHANGE_2020, data = matrix1, prior = R2(0.5, what = "mean"))
lm6 <- stan_lm(election_day ~  HESIT +VOTES_2020, data = matrix1, prior = R2(0.5, what = "mean"))        
```
```{r}
summary(lm1, digits = 4)
```
```{r}
summary(lm2,digits = 4)
```

```{r}
summary(lm3, digits = 4)
```

```{r}
summary(lm4, digits = 41)
```

```{r}
summary(lm5, digits =4)
```
Model 4
```{r}
summary(lm6, digits = 4)
```



